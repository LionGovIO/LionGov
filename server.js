/** TechLead is so cool!!! He knows da wae!!! https://www.youtube.com/c/TechLead ***************************************
...........-....--...`````..............................................................................................
........................................................................................................................
..........................................................----..........................................................
..............................`````...................-/oyhhhhhy+-......``````...................................```````
....................................................:ohddmmmmddddho...`````````````..................................```
...................................................:hmmmdhmmhhdmdmds..................```...`.`..`......................
....-.............................................-hmmmdssmhossdhdmdo...........................```.....................
..------........................................../mNmdhyyhyoooyhymmh...................................................
-.-------........................................./mmhyyhhhsyhhyssdmd...................................................
----------.-.......................................hdsooooo/+oo+++shy.....................................`.............
-----------........................`.............../yooooso++++++++s+.....................................`.`..`........
-----------....-----...............`................+ossssyysooo++//-...................................................
------------....-----------..........................:oosssooso+++-.....................................................
.......--.................----......................../soooo+++oo:......................................................
....................-.....---..........................+yyssssss+-.........................``````.......................
...........`...........................................:oyhhhhso/:......................................................
.......................................................-osyysso++/ooo+:--------.......................----..............
...............................----------------.......:+ossooooshdddddhyo/--------......................-...............
...........................----------------------:/oyhho++++sddmmmmmmdddddh+-...-----------.............................
.....................-----------------------:+syhdmdddy//+sdmmmmmmmmmmdddddho.............-.--..........................
....--..........---------------------------+hmmmmmdddddosdmdddddmmmmmdddddddh-.................................````````.
-----------------------------------------:ydmmmmmddddmmmmddddmmmNmmmmmmmmdddh/................................``````````
----------------------------------------:ymmmNmmdddmmmmmmmmmmmmNNmmdddmmmmddh/---------------...----............````````
--::::::-----------------------------...sdmmNNmdmmmmmNmmmmmmmmNNmmmhyhhhhdddh+----------------....----------..........``
:::::::::::::::------------------------odmmmNNmmmmmmNNmmmmmmmNNmddhddddddhhdd/------------...----....-------............
::::::::::::::::::::::::-----------.../+oshdNNmmmmmNNmmmmmNNNNho+///+oshdddds-------------......-.....----------.-......
:::::::::::::::::---:-----------.....:::::/+sdmmmNNNNmmNmNNNNy/::::::::/sddy:-------------.............-----------------
:::::::::::::------.-......-----...-::://++++symNNNNmmNNNNNNy/:::://///+sNNo....----------..............----------------
:::::::::::-----------------------:/:////+o+oosdmNmmdddhddmh///::////++ymNd-...................---------------------::::
////////////////////::::::::///////////::::::://///::::::///////////+odNNmo-.................--------------------------:
++++++++++++++++++++++++++++++++++///////////++++++oos+/++++//////++ohmNmd:--------------:::::::::::::::--::::::::::::::
oooooooooo++++++++++++++++++++++++++++ooooossssssyyso++++++////++++oydmmmd/:://:::///::::::::///////////////////////////
oooooooooooooooooooooooooooo+++++osssyyssssssyhhhsooooooooooooo+ooshmNNmdy+///+//////////////////+++++++/////////////+++
oooooooooooooooooooooooooooooooooosyyssyyyyydhysoosssssyyyhhyyyhdmNNNNmmms+++++++++//////+++++++++++++++++++++++++++++++
ooooooooooooooooooooooooossssssoooooooooooooosdhhhyyhhhhdddmmNNMNNNNNNNmdy+++o++++++++++++++++++++++++++++++++++++++++++
oossoooosoooooooooooosssssssssssssssssssooooodmNNNNNNNNNNNMNNNNNNNNmNNNddyoooooooooooooooooooosssooooooooooooooooooooooo
sssssssssosssssssssssssssssssssssssssssssssssmmmmNNNNNNNNNNNNNNNmNNmmmNmdsosssssssssssssssssssssssoooooosssssssssooossss
ssssssssssssssssssssssssssssssssssssssssssssymmNNNNNNNNNNNNNNNNNmmNmmmNmhsssssssssssssssssssssssssssssssssssssssssssssss
sssssssssssssssssssssssssssssssssssssssssssshmNNNNNNNNNNNNNNNNNNmmmNmmmmhssssssssssssssssssssyyysyyysssssssyyyyyyyyyyyyy
ssssssssssssssssssssssssyssssssssssssssssssshmNNNNNNNNNNNNNNNNNmmmmmmmmmysssssssssssssssssssssssyyyyyyyssysyyyyyyyyyyyyy
ssoosssssssssssssssssssssssssssssssssssssssshNNNNNNNNNNNNNNNNNNmmmmmmmmdysssssssssyyysssssyysyyyyyyysyyysssyyyyyyyyyyyyy
ssosssssssssssssssssssssssssssssssyyyyssssshNNNNNmmNNNNNNNNmmNNNNmmmmdddyyyysyyysssssssyyyyyyyyyyyyyyyyyyyyyyyyyssyyyyyy
ysssssssysssssssssyysyyyyysssssssssssssyyshNmmNmmmNNNNNmmmmNNNmmmNNNmmmhyysyyysyssyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyssyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyysssssssymmNNmmNNNNNNmmmmmmNNNNmmmmmhyysssysyyyssssyyyyyyyyyyyyyyyyyyyyyyssyyyyyysssyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhmmmNNNNNNNNNNNNNNNNmmmmmmNdyyyyyyyyyyysysssssyyyyyyyyyyyyyyyyyyyyyssyyyyyysss
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhhhyyyyyddmmmmmNNNNNNNNNNmmmddhhdddhyyyyyyyyyyyyyyyssssssyyyyyyyyyyyyyyyyyyyysssssyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhhyhyhddmmmmmNmNmmddddddhhhhhhhhyyyyyyyyyyyyyyyyyyysyyysyyyyyyyyyyyyhhyyyyyyyysssssyy
yyyyyyyyyyyssyyyyyyyyyyyyyhyyyyyyyyyyhyyhddmmmmmmmmmmdddhhhhhhhhhhhhhsyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyysyyyyyyyyyyyyyyyyyyhhhyyyyyyyhhhdddmmdmdmmmmddhhhhhhhhhhhhhyyyyyyyyyyyyyyyysysssysyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyhhhhhhhhhhhhyyhhhdddddmdmmmmdmdddddddddddhhhhyyyyyyyyyyyyyysyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
hhyyhyyyyyhyhhhhhhhhhhhhhhhhhhhhhhhhyyhhhdddddmmmdmmddddddhhhddddddhhyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyssyyyy
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhyyyyyssyhhhddddmmmmmmmddddddddhhhddhdhhyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhyyyyyyyyyyyyyyyhh
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhyyyyysssyyhddmmmNNNmmmddddddddhhhhhhhhhyyyyyyyyyysyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhhhhhhhh
hhhhhhhhhhhhhhhhhhyhhhhhhhhhhhhhhhhyyyyhdmmmmmmmNNmmdhhddddddhhdddddhsyyyyyyyyyssssyyyyyyyyysyyyyyyyyyyyyyyhhhhhhhhhhhhh
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhyhhddmmmmmmmNNNNdmhyhhddddhhhdddddyyyyyyyyyyyyyyyyyyyyssyyyyyyhyyyyhhhyhhhhhhhhhhhhhh
hhhhhyhhhhhhhhhhhhhhhhhhhhhhdhhddhyyyhdmmmmmmmNNNmhhdhyyhhdddddhhdddhyyyyyyyyyyyyyyyyyyyyyyyyyyhhhyyhhhyhhhhhhhhhhhhhhhh
hhhhhyyhhhhhhhdhhhhhhhddhdhhdddddhyyhddmmmmmmNNNmhhhhhyyhhddddddddddhysyyyyyyyyyyyyyyyyyyyyyyyhhhhyyyyyhhhhhhhhhhhhhhhhh
yyyyyhhhhhhhhddhdhhhddddhdhdddhddyyhddmmmmmmNNNNdhhhhhyyhhhddmmdhhdddyyyhhyyyyyyyyyyyyyyyyyyyyyhhhhyyyyyyyyyyyhyyyhhhhhh
hhhhhhhhhhhhhhhhhhddhhhhdddhhdddhyhdddmmmmmmNNNmddhdhhhhhyyhdmmmmdhhhyyhyhhyyhyyyyyyhyyyyyyyyyhhhyyyyyyhhyyyyyyyyyyhhyyy
hhhhhhhhhhhhhhddddhhhhhhhhhddddhhhdddmmmmmmmNmdddddddhhhhhhhhddmmddddhhhhhhhhhhhyyyhyyyhyyhyyyhhhhhhhhhhyyyhhyyyyyyyyyyy
hhhhhhhhhyydddhhdhhhhhhhhhhhhhhhhhhddmmmmmmmmmhddddddddhhhddhhhdmmddhhhhhhhhhhyyyyyyyhhyyyhhhyyhhhyyhyhhyyyhhhhhhyyhyysy
dddhhhhhhhhhdddhhhhhhhhhhhhhhhhddhhhddmmmmmmmmddddddddddyyhdddhhdddmmdhhhhhyyyyyhhhhhhhyyyyyyhhhhhhhhhyhyhyyyhhhhhhyyyyy
***********************************************************************************************************************/

const { v4: uuidv4 } = require('uuid');

const express = require('express');
const app = express();
const http = require('http');
const server = http.createServer(app);
const _debug = require('debug');
const compression = require('compression');
const requireDir = require("requiredir");
const controllers = requireDir('./controllers');
let Controllers = {};
debug = _debug("liongov");
debug('Debugging liongov');

// Compress all HTTP responses
// This compression should be the first use of app.use to guarantee compression is actually working
app.use(compression()); // TODO: add this compression to lionrun as well

var ethers = require('ethers');
const c = require('./public/blockchain/constants');
const blkchain = require('./public/blockchain/blockchain');
const Moralis = require('moralis/node');

const AWS = require("aws-sdk");
AWS.config.update({
  region: 'us-east-1'
});

dynamoDB = new AWS.DynamoDB(); // Global scope

Moralis.initialize(process.env.MORALIS_APP_ID);

Moralis.serverURL = process.env.MORALIS_SERVER_URL;

Blkchain = new blkchain(null, Moralis); // Global scope


app.use(express.static('public'))
app.use(express.static('dist'))

// body-parser is deprecated, using below instead: https://stackoverflow.com/questions/66525078/bodyparser-is-deprecated
app.use(express.urlencoded({ extended: true }));
app.use(express.json()) // To parse the incoming requests with JSON payloads


app.get('/', (req, res) => {
  res.send('Hello World!')
});

let controller_this = {Blkchain, dynamoDB, _debug}; //Obj that will be accessible in controller 'this'

// Load routes and controllers

Object.keys(controllers).forEach((Contr_name) => {
  if(Contr_name == "length" || Contr_name == "toArray"){return;}
  controller_this.debug = debug.extend(Contr_name);
  Controller = Controllers[Contr_name] = new controllers[Contr_name](controller_this);
  let namel = Contr_name.toLowerCase();
  if(Controller.get) {
    app.get('/' + namel, Controller.get);
  }
  if(Controller.post) {
    app.post('/' + namel, Controller.post);
  }
});

// TODO: add filtering/validation on all the APIS. In particular, want to prevent database injection attacks
// TOOD: add API throttling (e.g. by IP address), there are various libraries for that
// TODO: add DDOS protection (e.g. AWS provides some services for this). We can do this after we add a load balancer.

// TODO: show error to client when voting twice


server.listen(3000, () => {
  console.log('listening on *:3000');

  Controllers.privacyVoteQuery._privacyVoteQuery({
    voteClass: 'matrix'
  }, () => {

  });
});
