/** TechLead is so cool!!! He knows da wae!!! https://www.youtube.com/c/TechLead ***************************************
...........-....--...`````..............................................................................................
........................................................................................................................
..........................................................----..........................................................
..............................`````...................-/oyhhhhhy+-......``````...................................```````
....................................................:ohddmmmmddddho...`````````````..................................```
...................................................:hmmmdhmmhhdmdmds..................```...`.`..`......................
....-.............................................-hmmmdssmhossdhdmdo...........................```.....................
..------........................................../mNmdhyyhyoooyhymmh...................................................
-.-------........................................./mmhyyhhhsyhhyssdmd...................................................
----------.-.......................................hdsooooo/+oo+++shy.....................................`.............
-----------........................`.............../yooooso++++++++s+.....................................`.`..`........
-----------....-----...............`................+ossssyysooo++//-...................................................
------------....-----------..........................:oosssooso+++-.....................................................
.......--.................----......................../soooo+++oo:......................................................
....................-.....---..........................+yyssssss+-.........................``````.......................
...........`...........................................:oyhhhhso/:......................................................
.......................................................-osyysso++/ooo+:--------.......................----..............
...............................----------------.......:+ossooooshdddddhyo/--------......................-...............
...........................----------------------:/oyhho++++sddmmmmmmdddddh+-...-----------.............................
.....................-----------------------:+syhdmdddy//+sdmmmmmmmmmmdddddho.............-.--..........................
....--..........---------------------------+hmmmmmdddddosdmdddddmmmmmdddddddh-.................................````````.
-----------------------------------------:ydmmmmmddddmmmmddddmmmNmmmmmmmmdddh/................................``````````
----------------------------------------:ymmmNmmdddmmmmmmmmmmmmNNmmdddmmmmddh/---------------...----............````````
--::::::-----------------------------...sdmmNNmdmmmmmNmmmmmmmmNNmmmhyhhhhdddh+----------------....----------..........``
:::::::::::::::------------------------odmmmNNmmmmmmNNmmmmmmmNNmddhddddddhhdd/------------...----....-------............
::::::::::::::::::::::::-----------.../+oshdNNmmmmmNNmmmmmNNNNho+///+oshdddds-------------......-.....----------.-......
:::::::::::::::::---:-----------.....:::::/+sdmmmNNNNmmNmNNNNy/::::::::/sddy:-------------.............-----------------
:::::::::::::------.-......-----...-::://++++symNNNNmmNNNNNNy/:::://///+sNNo....----------..............----------------
:::::::::::-----------------------:/:////+o+oosdmNmmdddhddmh///::////++ymNd-...................---------------------::::
////////////////////::::::::///////////::::::://///::::::///////////+odNNmo-.................--------------------------:
++++++++++++++++++++++++++++++++++///////////++++++oos+/++++//////++ohmNmd:--------------:::::::::::::::--::::::::::::::
oooooooooo++++++++++++++++++++++++++++ooooossssssyyso++++++////++++oydmmmd/:://:::///::::::::///////////////////////////
oooooooooooooooooooooooooooo+++++osssyyssssssyhhhsooooooooooooo+ooshmNNmdy+///+//////////////////+++++++/////////////+++
oooooooooooooooooooooooooooooooooosyyssyyyyydhysoosssssyyyhhyyyhdmNNNNmmms+++++++++//////+++++++++++++++++++++++++++++++
ooooooooooooooooooooooooossssssoooooooooooooosdhhhyyhhhhdddmmNNMNNNNNNNmdy+++o++++++++++++++++++++++++++++++++++++++++++
oossoooosoooooooooooosssssssssssssssssssooooodmNNNNNNNNNNNMNNNNNNNNmNNNddyoooooooooooooooooooosssooooooooooooooooooooooo
sssssssssosssssssssssssssssssssssssssssssssssmmmmNNNNNNNNNNNNNNNmNNmmmNmdsosssssssssssssssssssssssoooooosssssssssooossss
ssssssssssssssssssssssssssssssssssssssssssssymmNNNNNNNNNNNNNNNNNmmNmmmNmhsssssssssssssssssssssssssssssssssssssssssssssss
sssssssssssssssssssssssssssssssssssssssssssshmNNNNNNNNNNNNNNNNNNmmmNmmmmhssssssssssssssssssssyyysyyysssssssyyyyyyyyyyyyy
ssssssssssssssssssssssssyssssssssssssssssssshmNNNNNNNNNNNNNNNNNmmmmmmmmmysssssssssssssssssssssssyyyyyyyssysyyyyyyyyyyyyy
ssoosssssssssssssssssssssssssssssssssssssssshNNNNNNNNNNNNNNNNNNmmmmmmmmdysssssssssyyysssssyysyyyyyyysyyysssyyyyyyyyyyyyy
ssosssssssssssssssssssssssssssssssyyyyssssshNNNNNmmNNNNNNNNmmNNNNmmmmdddyyyysyyysssssssyyyyyyyyyyyyyyyyyyyyyyyyyssyyyyyy
ysssssssysssssssssyysyyyyysssssssssssssyyshNmmNmmmNNNNNmmmmNNNmmmNNNmmmhyysyyysyssyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyssyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyysssssssymmNNmmNNNNNNmmmmmmNNNNmmmmmhyysssysyyyssssyyyyyyyyyyyyyyyyyyyyyyssyyyyyysssyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhmmmNNNNNNNNNNNNNNNNmmmmmmNdyyyyyyyyyyysysssssyyyyyyyyyyyyyyyyyyyyyssyyyyyysss
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhhhyyyyyddmmmmmNNNNNNNNNNmmmddhhdddhyyyyyyyyyyyyyyyssssssyyyyyyyyyyyyyyyyyyyysssssyyyy
yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhhyhyhddmmmmmNmNmmddddddhhhhhhhhyyyyyyyyyyyyyyyyyyysyyysyyyyyyyyyyyyhhyyyyyyyysssssyy
yyyyyyyyyyyssyyyyyyyyyyyyyhyyyyyyyyyyhyyhddmmmmmmmmmmdddhhhhhhhhhhhhhsyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyysyyyyyyyyyyyyyyyyyyhhhyyyyyyyhhhdddmmdmdmmmmddhhhhhhhhhhhhhyyyyyyyyyyyyyyyysysssysyyyyyyyyyyyyyyyyyyyyyyyyyyyy
yyyyyyyyyyyyyyyyyyyyyyyyhhhhhhhhhhhhyyhhhdddddmdmmmmdmdddddddddddhhhhyyyyyyyyyyyyyysyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy
hhyyhyyyyyhyhhhhhhhhhhhhhhhhhhhhhhhhyyhhhdddddmmmdmmddddddhhhddddddhhyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyssyyyy
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhyyyyyssyhhhddddmmmmmmmddddddddhhhddhdhhyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhyyyyyyyyyyyyyyyhh
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhyyyyysssyyhddmmmNNNmmmddddddddhhhhhhhhhyyyyyyyyyysyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyhhhhhhhh
hhhhhhhhhhhhhhhhhhyhhhhhhhhhhhhhhhhyyyyhdmmmmmmmNNmmdhhddddddhhdddddhsyyyyyyyyyssssyyyyyyyyysyyyyyyyyyyyyyyhhhhhhhhhhhhh
hhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhhyhhddmmmmmmmNNNNdmhyhhddddhhhdddddyyyyyyyyyyyyyyyyyyyyssyyyyyyhyyyyhhhyhhhhhhhhhhhhhh
hhhhhyhhhhhhhhhhhhhhhhhhhhhhdhhddhyyyhdmmmmmmmNNNmhhdhyyhhdddddhhdddhyyyyyyyyyyyyyyyyyyyyyyyyyyhhhyyhhhyhhhhhhhhhhhhhhhh
hhhhhyyhhhhhhhdhhhhhhhddhdhhdddddhyyhddmmmmmmNNNmhhhhhyyhhddddddddddhysyyyyyyyyyyyyyyyyyyyyyyyhhhhyyyyyhhhhhhhhhhhhhhhhh
yyyyyhhhhhhhhddhdhhhddddhdhdddhddyyhddmmmmmmNNNNdhhhhhyyhhhddmmdhhdddyyyhhyyyyyyyyyyyyyyyyyyyyyhhhhyyyyyyyyyyyhyyyhhhhhh
hhhhhhhhhhhhhhhhhhddhhhhdddhhdddhyhdddmmmmmmNNNmddhdhhhhhyyhdmmmmdhhhyyhyhhyyhyyyyyyhyyyyyyyyyhhhyyyyyyhhyyyyyyyyyyhhyyy
hhhhhhhhhhhhhhddddhhhhhhhhhddddhhhdddmmmmmmmNmdddddddhhhhhhhhddmmddddhhhhhhhhhhhyyyhyyyhyyhyyyhhhhhhhhhhyyyhhyyyyyyyyyyy
hhhhhhhhhyydddhhdhhhhhhhhhhhhhhhhhhddmmmmmmmmmhddddddddhhhddhhhdmmddhhhhhhhhhhyyyyyyyhhyyyhhhyyhhhyyhyhhyyyhhhhhhyyhyysy
dddhhhhhhhhhdddhhhhhhhhhhhhhhhhddhhhddmmmmmmmmddddddddddyyhdddhhdddmmdhhhhhyyyyyhhhhhhhyyyyyyhhhhhhhhhyhyhyyyhhhhhhyyyyy
***********************************************************************************************************************/

const { v4: uuidv4 } = require('uuid');

const express = require('express');
const app = express();
const http = require('http');
const server = http.createServer(app);
const compression = require('compression');

// Compress all HTTP responses
// This compression should be the first use of app.use to guarantee compression is actually working
app.use(compression()); // TODO: add this compression to lionrun as well

var ethers = require('ethers');
const c = require('./public/blockchain/constants');
const blkchain = require('./public/blockchain/blockchain');
const Moralis = require('moralis/node');
const Controllers = require('./controllers');

const AWS = require("aws-sdk");
AWS.config.update({
  region: 'us-east-1'
});

var dynamoDB = new AWS.DynamoDB();

Moralis.initialize(process.env.MORALIS_APP_ID);

Moralis.serverURL = process.env.MORALIS_SERVER_URL;

/*
(async () => {
    var redisClient = null;
    Blkchain = new blkchain(redisClient, Moralis);

})();
*/

Blkchain = new blkchain(null, Moralis);


app.use(express.static('public'))
app.use(express.static('dist'))

// body-parser is deprecated, using below instead: https://stackoverflow.com/questions/66525078/bodyparser-is-deprecated
app.use(express.urlencoded({ extended: true }));
app.use(express.json()) // To parse the incoming requests with JSON payloads

// var redisClient = null;
// var Blkchain = new blkchain(redisClient, Moralis);

app.get('/', (req, res) => {
  res.send('Hello World!')
});

// TODO: add filtering/validation on all the APIS. In particular, want to prevent database injection attacks
// TOOD: add API throttling (e.g. by IP address), there are various libraries for that
// TODO: add DDOS protection (e.g. AWS provides some services for this). We can do this after we add a load balancer.

app.get('/getvoteweight', Controllers.getVoteWeight);

// TODO: show error to client when voting twice

// semi-private since it doesn't reveal who created the proposal
// TODO: come up with better / more consisten names for all these APIs!!! ;)

app.get('/privacyproposalquery', Controllers.privacyProposalQuery);

app.get('/getvotestats', Controllers.getVoteStats);

// TODO: when you vote, refresh the table, your vote should show up as latest one
app.get('/privacyvotequery', Controllers.privacyVoteQuery);

// POST method route
app.post('/submitproposal', Controllers.submitProposal);

// POST method route
app.post('/submitvote', Controllers.submitVote);

// TODO: don't console.log vote data in long term to protect user privacy

server.listen(3000, () => {
  console.log('listening on *:3000');

  Controllers._privacyVoteQuery({
    voteClass: 'matrix'
  }, () => {

  });
});
